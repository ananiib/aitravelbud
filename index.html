<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Travel Buddy</title>
  <link rel="stylesheet" href="styles.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    /* Map styles for index */
    #home-map { height: 420px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .home-map-controls { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
  </style>
</head>
<body>
  
  <div style="max-width: 960px; margin: 10px auto 0 auto; display: flex; justify-content: flex-end; gap: 12px;">
    <a href="/dashboard.html" style="color:#00796b; font-weight: 600; text-decoration: none;">User Dashboard</a>
  </div>

<h1>AI Travel BuddyğŸ“¸âœˆï¸ğŸ¹ğŸŒğŸ’</h1>
<p>Plan your next trip with personalised AI guidance!</p>
<p style="font-size: 18px; font-weight: bold;">Start Planning</p>


<form id="trip-form">
  <label for="destination">Destination:</label>
  <input type="text" name="destination" id="destination" required><br>
  
  <div class="date-range">
    <div class="date-field">
      <label for="date-from">From:</label>
      <input type="date" name="date-from" id="date-from" required>
    </div>
    
    <div class="date-field">
      <label for="date-to">To:</label>
      <input type="date" name="date-to" id="date-to" required>
    </div>
  </div>
  
  <label for="preferences">Preferences:</label>
  <select name="preferences" id="preferences">
    <option value="adventure">Adventure</option>
    <option value="relaxation">Relaxation</option>
    <option value="culture">Culture</option>
    <option value="food">Food</option>
    <option value="shopping">Shopping</option>
    <option value="romantic">Romantic</option>
  </select><br>
  
  <button type="submit">Generate Trip</button>
</form>
  
<div id="ai-response"></div>

<div class="itinerary-actions" id="itinerary-actions" style="display: none;">
  <button onclick="saveItinerary()" class="save-btn">ğŸ’¾ Save Itinerary</button>
  <button onclick="shareItinerary()" class="share-btn">ğŸ“¤ Share Itinerary</button>
</div>

<!-- Saved Itineraries Section -->
<div class="saved-itineraries">
  <h3>ğŸ’¼ Saved Itineraries</h3>
  <div id="saved-list"></div>
</div>

<!-- Interactive Map on Home -->
<div class="section" id="home-map-section" style="max-width: 960px; margin: 20px auto; text-align: left; background: #f9fafb; padding: 16px; border-radius: 8px;">
  <h2>Interactive Map</h2>
  <div id="home-map"></div>
  <div class="home-map-controls">
    <button class="btn" onclick="homeLocateUser()">Locate Me</button>
    <button class="btn secondary" onclick="homeClearMapMarkers()">Clear Markers</button>
    <button class="btn" onclick="suggestAndPlotDestinations()">Suggest Destinations</button>
  </div>
  <p style="color:#666; font-size: 14px; margin-top:8px;">Click the map to add markers. They persist in your browser.</p>
  
</div>

     <h2>AI Travel Buddy Chat</h2>
<div class="chat-input">
  <input type="text" id="question" placeholder="Ask a travel question">
  <button onclick="askAI()">Send</button>
</div>
<div id="chat-response"></div>
  
  
   <h1>Travel Tips ğŸ¸ğŸŸğŸ§³ğŸŒŸ</h1>
  <p class="author">.</p>

  
  <div class="page-layout">
    <div class="left-column">
      <div class="tooltip">
        <img src="https://i.ibb.co/kS2WcNt/IMG-5883.jpg" alt="Flight Tips">
        <div class="title">Flights</div>
        <div class="tooltip-content">
          <p>Check for cheaper flights on weekdays, and use incognito mode while searching!</p>
        </div>
      </div>
      <div class="tooltip">
        <img src="https://i.ibb.co/tM9zdgK/IMG-5884.jpg" alt="Packing Tips">
        <div class="title">Packing</div>
        <div class="tooltip-content">
          <p>Roll your clothes to save space, and don't forget to pack a power adapter!</p>
        </div>
      </div>
      <div class="tooltip">
        <img src="https://i.ibb.co/740sd1D/IMG-5886.jpg" alt="Accommodation Tips">
        <div class="title">Accommodation</div>
        <div class="tooltip-content">
          <p>Research reviews on booking sites and look for hidden gems with good safety ratings.</p>
        </div>
      </div>
    </div>

    <div class="center-column">
      <p class="vertical-text">TRAVEL</p>
    </div>

    <div class="right-column">
      <div class="tooltip">
        <img src="https://i.ibb.co/R0C306c/IMG-5892.jpg" alt="Activity Tips">
        <div class="title">Activities</div>
        <div class="tooltip-content">
          <p>Leave room for spontaneous adventures! Plan activities ahead to ensure you do not miss out on gems!</p>
        </div>
      </div>
      <div class="tooltip">
        <img src="https://i.ibb.co/H79y3YP/IMG-5887.jpg" alt="Food Tips">
        <div class="title">Food</div>
        <div class="tooltip-content">
          <p>Always try traditional local food for authentic flavors, but ensure it's from clean and trusted vendors.</p>
        </div>
      </div>
      <div class="tooltip">
        <img src="https://i.ibb.co/s6YbnkW/IMG-5890.jpg" alt="Memories Tips">
        <div class="title">Memories</div>
        <div class="tooltip-content">
          <p>Capture moments, write about your experiences, and cherish the memories you create!</p>
        </div>
      </div>
    </div>
  </div>
 
  
  <footer>
    <p>Every destination brings out a new adventure, Live It! ğŸŒâœˆï¸</p>
  </footer>
  
<script>
// Load Leaflet JS
</script>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
// Set minimum date to today and handle date range validation
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');
    const preferencesSelect = document.getElementById('preferences');
    const PREFS_KEY = 'atb_user_preferences';
    const PROFILE_KEY = 'atb_user_profile';
    
    // Set minimum date to today for both fields
    dateFrom.min = today;
    dateTo.min = today;
    
    // Set default dates
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateFrom.value = tomorrow.toISOString().split('T')[0];
    
    const dayAfterTomorrow = new Date();
    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
    dateTo.value = dayAfterTomorrow.toISOString().split('T')[0];
    
    // Update "To" date minimum when "From" date changes
    dateFrom.addEventListener('change', function() {
        dateTo.min = this.value;
        if (dateTo.value && dateTo.value < this.value) {
            dateTo.value = this.value;
        }
    });
    
    // Validate "To" date is not before "From" date
    dateTo.addEventListener('change', function() {
        if (this.value < dateFrom.value) {
            alert('End date must be after start date!');
            this.value = dateFrom.value;
        }
    });

    // Load saved user preferences as defaults if available
    try {
      const savedPrefs = JSON.parse(localStorage.getItem(PREFS_KEY) || 'null');
      if (savedPrefs && savedPrefs.primary) {
        preferencesSelect.value = savedPrefs.primary;
      }
    } catch (e) {}
});

document.getElementById("trip-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const destination = document.getElementById("destination").value;
    const dateFrom = document.getElementById("date-from").value;
    const dateTo = document.getElementById("date-to").value;
    const preferences = document.getElementById("preferences").value;

    const response = await fetch("/ai", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ 
        destination, 
        dateFrom, 
        dateTo, 
        preferences 
      })
    });

    const data = await response.json();
    const output = document.getElementById("ai-response");

    const formatItinerary = (text) => {
      const escapeHtml = (s) => s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      if (!text) return '<div class="itinerary-card"><div class="itinerary-body">No content.</div></div>';
      const escaped = escapeHtml(text.trim());
      // Basic formatting: paragraphs and line breaks
      const withParas = '<p>' + escaped.replace(/\n\n+/g, '</p><p>') + '</p>';
      const withBreaks = withParas.replace(/\n/g, '<br>');
      return `
        <div class="itinerary-card">
          <div class="itinerary-header">
            <div class="itinerary-title">Your Travel Itinerary</div>
            <div class="itinerary-badges">
              <span class="badge">AI Plan</span>
            </div>
          </div>
          <div class="itinerary-body">${withBreaks}</div>
        </div>`;
    };

    if (!response.ok || data.error) {
      output.innerHTML = formatItinerary(data.answer || `Error: ${data.error || 'Unknown error'}`);
    } else if (typeof data.answer === 'string' && data.answer.trim()) {
      output.innerHTML = formatItinerary(data.answer);
    } else {
      output.innerHTML = formatItinerary('Sorry, no answer was generated.');
    }
    
    // Show save buttons after getting response
    document.getElementById("itinerary-actions").style.display = "block";
    
    // Store current itinerary data for saving
    window.currentItinerary = {
      destination,
      dateFrom,
      dateTo,
      preferences,
      response: data.answer,
      timestamp: new Date().toISOString(),
      user: (function(){
        try {
          const p = JSON.parse(localStorage.getItem('atb_user_profile') || 'null');
          return p ? { name: p.name || '', email: p.email || '', homeAirport: p.homeAirport || '', budget: p.budget || '' } : null;
        } catch(e) { return null; }
      })()
    };
  });
  
  function askAI() {
    const question = document.getElementById("question").value;
    if (!question.trim()) return;
    
    fetch("/ai", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ question })
    })
    .then(response => response.json())
    .then(data => {
      const chatOut = document.getElementById("chat-response");
      const formatChat = (text) => {
        const escapeHtml = (s) => s
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        if (!text) return 'No response.';
        return escapeHtml(text).replace(/\n/g, '<br>');
      };
      if (data.error) {
        chatOut.innerHTML = formatChat(data.answer || ("Error: " + data.error));
      } else if (typeof data.answer === 'string' && data.answer.trim()) {
        chatOut.innerHTML = formatChat(data.answer);
      } else {
        chatOut.innerHTML = 'Sorry, no answer was generated.';
      }
    })
    .catch(error => {
      document.getElementById("chat-response").innerText = "Error: " + error.message;
    });
  }
  
  // Save current itinerary to local storage
  function saveItinerary() {
    if (!window.currentItinerary) {
      alert("No itinerary to save! Generate a trip plan first.");
      return;
    }
    
    const savedItineraries = JSON.parse(localStorage.getItem('travelItineraries') || '[]');
    const itineraryName = prompt("Give your itinerary a name:", 
      `${window.currentItinerary.destination} Trip - ${new Date(window.currentItinerary.dateFrom).toLocaleDateString()}`);
    
    if (itineraryName) {
      const itineraryToSave = {
        ...window.currentItinerary,
        name: itineraryName,
        id: Date.now()
      };
      
      savedItineraries.push(itineraryToSave);
      localStorage.setItem('travelItineraries', JSON.stringify(savedItineraries));
      
      alert("âœ… Itinerary saved successfully!");
      loadSavedItineraries();
    }
  }
  
  // Load and display saved itineraries
  function loadSavedItineraries() {
    const savedItineraries = JSON.parse(localStorage.getItem('travelItineraries') || '[]');
    const savedList = document.getElementById('saved-list');
    
    if (savedItineraries.length === 0) {
      savedList.innerHTML = '<p class="no-itineraries">No saved itineraries yet. Generate and save your first trip plan! ğŸš€</p>';
      return;
    }
    
    savedList.innerHTML = savedItineraries.map(itinerary => `
      <div class="saved-itinerary" data-id="${itinerary.id}">
        <div class="itinerary-header">
          <h4>${itinerary.name}</h4>
          <div class="itinerary-actions-mini">
            <button onclick="viewItinerary(${itinerary.id})" class="view-btn">ğŸ‘ï¸ View</button>
            <button onclick="deleteItinerary(${itinerary.id})" class="delete-btn">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
        <div class="itinerary-details">
          <p><strong>Destination:</strong> ${itinerary.destination}</p>
          <p><strong>Dates:</strong> ${new Date(itinerary.dateFrom).toLocaleDateString()} - ${new Date(itinerary.dateTo).toLocaleDateString()}</p>
          <p><strong>Preferences:</strong> ${itinerary.preferences}</p>
          <p><strong>Saved:</strong> ${new Date(itinerary.timestamp).toLocaleDateString()}</p>
        </div>
      </div>
    `).join('');
  }
  
  // View a specific itinerary
  function viewItinerary(id) {
    const savedItineraries = JSON.parse(localStorage.getItem('travelItineraries') || '[]');
    const itinerary = savedItineraries.find(i => i.id === id);
    
    if (itinerary) {
      const viewWindow = window.open('', '_blank');
      viewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${itinerary.name}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
            .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
            h1 { color: #00796b; border-bottom: 2px solid #00796b; padding-bottom: 10px; }
            .detail { margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 5px; }
            .itinerary-response { background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0; white-space: pre-wrap; }
            .print-btn { background: #00796b; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
            .print-btn:hover { background: #005a4f; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>${itinerary.name}</h1>
            <div class="detail"><strong>Destination:</strong> ${itinerary.destination}</div>
            <div class="detail"><strong>Travel Dates:</strong> ${new Date(itinerary.dateFrom).toLocaleDateString()} - ${new Date(itinerary.dateTo).toLocaleDateString()}</div>
            <div class="detail"><strong>Preferences:</strong> ${itinerary.preferences}</div>
            <div class="detail"><strong>Saved on:</strong> ${new Date(itinerary.timestamp).toLocaleDateString()}</div>
            <h3>AI Travel Plan:</h3>
            <div class="itinerary-response">${itinerary.response}</div>
            <button onclick="window.print()" class="print-btn">ğŸ–¨ï¸ Print Itinerary</button>
            <button onclick="window.close()" class="print-btn">âŒ Close</button>
          </div>
        </body>
        </html>
      `);
    }
  }
  
  // Delete a saved itinerary
  function deleteItinerary(id) {
    if (confirm("Are you sure you want to delete this itinerary?")) {
      const savedItineraries = JSON.parse(localStorage.getItem('travelItineraries') || '[]');
      const updatedItineraries = savedItineraries.filter(i => i.id !== id);
      localStorage.setItem('travelItineraries', JSON.stringify(updatedItineraries));
      
      alert("ğŸ—‘ï¸ Itinerary deleted successfully!");
      loadSavedItineraries();
    }
  }
  
  // Share itinerary (copy to clipboard)
  function shareItinerary() {
    if (!window.currentItinerary) {
      alert("No itinerary to share! Generate a trip plan first.");
      return;
    }
    
    const shareText = `ğŸŒ Travel Itinerary: ${window.currentItinerary.destination}
ğŸ“… Dates: ${new Date(window.currentItinerary.dateFrom).toLocaleDateString()} - ${new Date(window.currentItinerary.dateTo).toLocaleDateString()}
ğŸ¯ Preferences: ${window.currentItinerary.preferences}
ğŸ¤– AI Plan: ${window.currentItinerary.response}
Generated by AI Travel Buddy âœˆï¸`;
    
    navigator.clipboard.writeText(shareText).then(() => {
      alert("ğŸ“‹ Itinerary copied to clipboard! You can now paste it anywhere.");
    }).catch(() => {
      // Fallback for older browsers
      const textArea = document.createElement("textarea");
      textArea.value = shareText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert("ğŸ“‹ Itinerary copied to clipboard! You can now paste it anywhere.");
    });
  }
  
  // Load saved itineraries when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadSavedItineraries();
    initHomeMap();
  });

  // Home Map logic
  const HOME_MAP_MARKERS_KEY = 'atb_home_map_markers';
  let homeMapInstance;
  let homeMarkerLayer;

  function homeLoadSavedMarkers() {
    try { return JSON.parse(localStorage.getItem(HOME_MAP_MARKERS_KEY) || '[]'); } catch(e) { return []; }
  }
  function homeSaveMarkers(markers) {
    localStorage.setItem(HOME_MAP_MARKERS_KEY, JSON.stringify(markers));
  }
  function homeGetCurrentMarkers() {
    const markers = [];
    if (!homeMarkerLayer) return markers;
    homeMarkerLayer.eachLayer(layer => {
      if (layer.getLatLng) {
        const { lat, lng } = layer.getLatLng();
        markers.push({ lat, lng });
      }
    });
    return markers;
  }
  function initHomeMap() {
    if (homeMapInstance) return;
    homeMapInstance = L.map('home-map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(homeMapInstance);
    homeMarkerLayer = L.layerGroup().addTo(homeMapInstance);
    const saved = homeLoadSavedMarkers();
    saved.forEach(({ lat, lng }) => L.marker([lat, lng]).addTo(homeMarkerLayer));
    homeMapInstance.on('click', (e) => {
      L.marker([e.latlng.lat, e.latlng.lng]).addTo(homeMarkerLayer);
      homeSaveMarkers(homeGetCurrentMarkers());
    });
  }
  function homeLocateUser() {
    if (!homeMapInstance) return;
    if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition((pos) => {
      const { latitude, longitude } = pos.coords;
      homeMapInstance.setView([latitude, longitude], 12);
      L.marker([latitude, longitude]).addTo(homeMarkerLayer);
      homeSaveMarkers(homeGetCurrentMarkers());
    }, () => alert('Unable to retrieve location'));
  }
  function homeClearMapMarkers() {
    if (!homeMarkerLayer) return;
    homeMarkerLayer.clearLayers();
    homeSaveMarkers([]);
  }

  async function suggestAndPlotDestinations() {
    try {
      const res = await fetch('/suggest-destinations', { method: 'POST' });
      const data = await res.json();
      const names = Array.isArray(data.destinations) ? data.destinations : [];
      if (!names.length) { alert('No suggestions received.'); return; }

      // Geocode each name with Nominatim
      const results = [];
      for (const name of names) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}`;
        const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const json = await r.json();
        if (Array.isArray(json) && json.length > 0) {
          const { lat, lon } = json[0];
          results.push({ name, lat: parseFloat(lat), lng: parseFloat(lon) });
          // Small delay to be nice to the service
          await new Promise(res => setTimeout(res, 250));
        }
      }

      if (!results.length) { alert('Unable to geocode suggestions.'); return; }

      // Clear existing, add markers, fit bounds, and persist
      homeMarkerLayer.clearLayers();
      const bounds = [];
      for (const p of results) {
        const m = L.marker([p.lat, p.lng]).addTo(homeMarkerLayer);
        m.bindPopup(p.name);
        bounds.push([p.lat, p.lng]);
      }
      if (bounds.length) {
        homeMapInstance.fitBounds(bounds, { padding: [30, 30] });
      }
      homeSaveMarkers(homeGetCurrentMarkers());
    } catch (e) {
      alert('Suggestion failed. Please try again.');
    }
  }
</script>

</body>
</html>
