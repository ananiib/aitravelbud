<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Travel Buddy</title>
  <link rel="stylesheet" href="styles.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    /* Map styles for index */
    #home-map { height: 420px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .home-map-controls { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
  </style>
</head>
<body>
  
  <div style="max-width: 960px; margin: 10px auto 0 auto; display: flex; justify-content: flex-end; gap: 12px;">
    <a href="/travel-tips.html" style="color:#00796b; font-weight: 600; text-decoration: none;">Travel Tips</a>
    <a href="/dashboard.html" style="color:#00796b; font-weight: 600; text-decoration: none;">User Dashboard</a>
  </div>

<h1>AI Travel Buddyüì∏‚úàÔ∏èüçπüåçüíû</h1>
<p>Plan your next trip with personalised AI guidance!</p>
<p style="font-size: 18px; font-weight: bold;">Start Planning</p>


<form id="trip-form">
  <label for="destination">Destination:</label>
  <input type="text" name="destination" id="destination" required><br>
  
  <div class="date-range">
    <div class="date-field">
      <label for="date-from">From:</label>
      <input type="date" name="date-from" id="date-from" required>
    </div>
    
    <div class="date-field">
      <label for="date-to">To:</label>
      <input type="date" name="date-to" id="date-to" required>
    </div>
  </div>
  
  <label for="preferences">Preferences (choose one or more):</label>
  <select name="preferences" id="preferences" multiple size="6">
    <option value="adventure">Adventure</option>
    <option value="relaxation">Relaxation</option>
    <option value="culture">Culture</option>
    <option value="food">Food</option>
    <option value="shopping">Shopping</option>
    <option value="romantic">Romantic</option>
  </select><br>
  
  <button type="submit">Generate Trip</button>
</form>
  
<div id="ai-response"></div>

<div class="itinerary-actions" id="itinerary-actions" style="display: none;">
  <button onclick="saveItinerary()" class="save-btn">üíæ Save Itinerary</button>
  <button onclick="shareItinerary()" class="share-btn">üì§ Share Itinerary</button>
  <button onclick="editItinerary()" class="edit-btn">‚úèÔ∏è Edit Itinerary</button>
</div>

  <!-- Itinerary Modal -->
  <div id="itinerary-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 1000;">
    <div style="max-width: 960px; margin: 40px auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.25);">
      <div style="display:flex; align-items:center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #e5e7eb;">
        <div style="font-weight: 700; color: #00796b;">Your Travel Itinerary</div>
        <button id="itinerary-modal-close" aria-label="Close itinerary" style="background: transparent; border: none; font-size: 22px; line-height: 1; cursor: pointer; color: #6b7280;">√ó</button>
      </div>
      <div id="itinerary-modal-body" style="padding: 16px; max-height: 70vh; overflow: auto;"></div>
      <div style="display:flex; justify-content: flex-end; gap: 8px; padding: 12px 16px; border-top: 1px solid #e5e7eb;">
        <button onclick="saveItinerary()" class="save-btn">üíæ Save</button>
        <button onclick="shareItinerary()" class="share-btn">üì§ Share</button>
        <button onclick="editItinerary()" class="edit-btn">‚úèÔ∏è Edit</button>
      </div>
    </div>
  </div>

<!-- Inline Itinerary Editor -->
<div id="itinerary-editor" style="display:none; max-width: 960px; margin: 12px auto; background:#fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 3px 10px rgba(0,0,0,0.06);">
  <div style="padding:10px 12px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
    <div style="font-weight:600; color:#374151;">Edit Itinerary Text</div>
    <div style="font-size:12px; color:#6b7280;">You can tweak the AI plan here</div>
  </div>
  <div style="padding:12px;">
    <textarea id="itinerary-edit-text" style="width:100%; min-height: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 14px; line-height:1.5; padding:10px; border:1px solid #e5e7eb; border-radius:6px; resize:vertical;"></textarea>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
      <button onclick="saveEditedItinerary()" class="btn">‚úÖ Save Changes</button>
      <button onclick="cancelEditItinerary()" class="btn secondary">‚úñÔ∏è Cancel</button>
    </div>
  </div>
  <div style="padding:8px 12px; background:#f9fafb; border-top:1px solid #e5e7eb; color:#6b7280; font-size:12px;">Formatting tips: Use plain text. Bold with **text**. Bullets with - item. Days like "Day 1: ..." will be bolded automatically.</div>
  
</div>

<!-- Saved Itineraries Section -->
<div class="saved-itineraries" id="saved-itineraries-section" style="display: none;">
  <h3>üíº Saved Itineraries</h3>
  <div id="saved-list"></div>
</div>

<!-- Interactive Map on Home -->
<div class="section" id="home-map-section" style="max-width: 960px; margin: 20px auto; text-align: left; background: #f9fafb; padding: 16px; border-radius: 8px;">
  <h2>Interactive Map</h2>
  <div id="home-map"></div>
  <div class="home-map-controls">
    <button class="btn" onclick="homeLocateUser()">Locate Me</button>
    <button class="btn secondary" onclick="homeClearMapMarkers()">Clear Markers</button>
    
  </div>
  <p style="color:#666; font-size: 14px; margin-top:8px;">Click the map to add markers. They persist in your browser.</p>
  
</div>

    <!-- Floating Chat Button and Popup -->
    <div id="chat-fab" style="position: fixed; right: 22px; bottom: 22px; width: 58px; height: 58px; border-radius: 50%; background: #00796b; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.25); z-index: 1100;" onclick="toggleChatWidget()" title="AI Travel Buddy Chat" aria-label="AI Travel Buddy Chat">
      üí¨
    </div>
    <div id="chat-popup" style="display: none; position: fixed; right: 22px; bottom: 90px; width: 320px; max-height: 60vh; background: white; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); overflow: hidden; z-index: 1100;">
      <div style="display:flex; align-items:center; justify-content: space-between; padding: 10px 12px; background: #00796b; color: white;">
        <div style="font-weight: 700;">Hey There Buddy :)</div>
        <button onclick="toggleChatWidget(false)" aria-label="Close chat" style="background: transparent; border: none; color: white; font-size: 18px; cursor: pointer;">√ó</button>
      </div>
      <div id="chat-response" style="padding: 10px; height: 260px; overflow: auto;"></div>
      <div style="display:flex; gap: 6px; padding: 10px; border-top: 1px solid #e5e7eb; background: #fafafa;">
        <input type="text" id="question" placeholder="Ask a travel question" style="flex:1; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px;" onkeydown="if(event.key==='Enter'){askAI();}">
        <button class="btn" onclick="askAI()">Send</button>
      </div>
    </div>
  
  <footer>
    <p>Every destination brings out a new adventure, Live It! üåç‚úàÔ∏è</p>
  </footer>
  
<script>
// Load Leaflet JS
</script>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
// Set minimum date to today and handle date range validation
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');
    const preferencesSelect = document.getElementById('preferences');
    const PREFS_KEY = 'atb_user_preferences';
    const PROFILE_KEY = 'atb_user_profile';
    
    // Set minimum date to today for both fields
    dateFrom.min = today;
    dateTo.min = today;
    
    // Set default dates
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateFrom.value = tomorrow.toISOString().split('T')[0];
    
    const dayAfterTomorrow = new Date();
    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
    dateTo.value = dayAfterTomorrow.toISOString().split('T')[0];
    
    // Update "To" date minimum when "From" date changes
    dateFrom.addEventListener('change', function() {
        dateTo.min = this.value;
        if (dateTo.value && dateTo.value < this.value) {
            dateTo.value = this.value;
        }
    });
    
    // Validate "To" date is not before "From" date
    dateTo.addEventListener('change', function() {
        if (this.value < dateFrom.value) {
            alert('End date must be after start date!');
            this.value = dateFrom.value;
        }
    });

    // Load saved user preferences as defaults if available
    try {
      const savedPrefs = JSON.parse(localStorage.getItem(PREFS_KEY) || 'null');
      if (savedPrefs) {
        const values = Array.isArray(savedPrefs.selected)
          ? savedPrefs.selected
          : (savedPrefs.primary ? [savedPrefs.primary] : []);
        for (const opt of preferencesSelect.options) {
          opt.selected = values.includes(opt.value);
        }
      }
    } catch (e) {}

    // Improve UX: allow clicking to toggle options without Cmd/Ctrl
    preferencesSelect.addEventListener('mousedown', function(e) {
      if (e.target && e.target.tagName === 'OPTION') {
        e.preventDefault();
        const option = e.target;
        option.selected = !option.selected;
      }
    });
});

// Formatting utilities shared by main view, print, and share
function formatItineraryBodyHTML(text) {
  const escapeHtml = (s) => s
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
  if (!text) return '';
  const escaped = escapeHtml(text.trim());

  // Inline **bold** ‚Üí <strong>
  const withBold = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

  const lines = withBold.split(/\n/);
  const htmlParts = [];
  let inList = false;

  const flushList = () => {
    if (inList) { htmlParts.push('</ul>'); inList = false; }
  };

  for (let raw of lines) {
    let line = raw.trim();
    if (!line) { flushList(); continue; }

    // Horizontal rule
    if (/^\s*-{3,}\s*$/.test(line)) { flushList(); htmlParts.push('<hr>'); continue; }

    // Strip markdown heading markers like ###
    line = line.replace(/^#{1,6}\s*/, '');

    // Bold Day headers and Additional Tips
    if (/^Day\s+/i.test(line) || /^Additional\s+Tips:?/i.test(line)) {
      flushList();
      htmlParts.push(`<p><strong>${line}</strong></p>`);
      continue;
    }

    // Bullet items
    if (/^[-*]\s+/.test(line)) {
      if (!inList) { htmlParts.push('<ul>'); inList = true; }
      htmlParts.push(`<li>${line.replace(/^[-*]\s+/, '')}</li>`);
      continue;
    }

    // Default paragraph (remove stray asterisks)
    line = line.replace(/\s?\*/g, '');
    flushList();
    htmlParts.push(`<p>${line}</p>`);
  }
  flushList();
  return htmlParts.join('');
}

function formatItinerary(text) {
  const body = formatItineraryBodyHTML(text);
  if (!body) return '<div class="itinerary-card"><div class="itinerary-body">No content.</div></div>';
  return `
    <div class="itinerary-card">
      <div class="itinerary-header">
        <div class="itinerary-title">Your Travel Itinerary</div>
        <div class="itinerary-badges">
          <span class="badge">AI Plan</span>
        </div>
      </div>
      <div class="itinerary-body">${body}</div>
    </div>`;
}

// Chat-specific card with different title
function formatChatCard(text) {
  const body = formatItineraryBodyHTML(text);
  if (!body) return '<div class="itinerary-card"><div class="itinerary-body">No response.</div></div>';
  return `
    <div class="itinerary-card">
      <div class="itinerary-header">
        <div class="itinerary-title">Hey There Buddy :)</div>
      </div>
      <div class="itinerary-body">${body}</div>
    </div>`;
}

function formatItineraryToPlainText(text) {
  // Use the HTML formatter, then strip tags to produce clean text without * or #
  const html = formatItineraryBodyHTML(text);
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  const plain = (tmp.textContent || tmp.innerText || '').replace(/\u00A0/g, ' ').trim();
  return plain;
}

document.getElementById("trip-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const destination = document.getElementById("destination").value;
    const dateFrom = document.getElementById("date-from").value;
    const dateTo = document.getElementById("date-to").value;
    const preferencesEl = document.getElementById('preferences');
    const preferences = Array.from(preferencesEl.selectedOptions).map(o => o.value).join(', ');

    // Immediately plot the entered destination(s) so users see pins right away
    updateMapPins(destination, '');

    const response = await fetch("/ai", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ 
        destination, 
        dateFrom, 
        dateTo, 
        preferences 
      })
    });

    const data = await response.json();
    const output = document.getElementById("ai-response");
    const modal = document.getElementById('itinerary-modal');
    const modalBody = document.getElementById('itinerary-modal-body');

    if (!response.ok || data.error) {
      modalBody.innerHTML = formatItinerary(data.answer || `Error: ${data.error || 'Unknown error'}`);
    } else if (typeof data.answer === 'string' && data.answer.trim()) {
      modalBody.innerHTML = formatItinerary(data.answer);
    } else {
      modalBody.innerHTML = formatItinerary('Sorry, no answer was generated.');
    }
    
    // Show itinerary in modal only (keep inline action buttons hidden)
    document.getElementById("itinerary-actions").style.display = "none";
    modal.style.display = 'block';
    
    // Store current itinerary data for saving
    window.currentItinerary = {
      destination,
      dateFrom,
      dateTo,
      preferences,
      response: data.answer,
      timestamp: new Date().toISOString(),
      user: (function(){
        try {
          const p = JSON.parse(localStorage.getItem('atb_user_profile') || 'null');
          return p ? { name: p.name || '', email: p.email || '', homeAirport: p.homeAirport || '', budget: p.budget || '' } : null;
        } catch(e) { return null; }
      })()
    };

    // After rendering, auto-plot the typed destinations and detected places from the itinerary
    updateMapPins(destination, data.answer || '');
  });
  
  function askAI() {
    const question = document.getElementById("question").value;
    if (!question.trim()) return;
    
    fetch("/ai", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ question })
    })
    .then(response => response.json())
    .then(data => {
      const chatOut = document.getElementById("chat-response");
      if (data.error) {
        chatOut.innerHTML = formatChatCard(data.answer || ("Error: " + data.error));
      } else if (typeof data.answer === 'string' && data.answer.trim()) {
        chatOut.innerHTML = formatChatCard(data.answer);
      } else {
        chatOut.innerHTML = formatChatCard('Sorry, no answer was generated.');
      }
    })
    .catch(error => {
      document.getElementById("chat-response").innerText = "Error: " + error.message;
    });
  }
  function toggleChatWidget(force) {
    const popup = document.getElementById('chat-popup');
    if (!popup) return;
    if (typeof force === 'boolean') {
      popup.style.display = force ? 'block' : 'none';
      return;
    }
    popup.style.display = (popup.style.display === 'none' || popup.style.display === '') ? 'block' : 'none';
  }
  
  // --- Auto-plot destinations and itinerary places on the home map (reworked) ---
  function parseDestinationInput(input) {
    if (!input) return [];
    // Split on commas or ' and ' to catch inputs like "Paris, Rome" or "Paris and Rome"
    return input
      .split(/,|\band\b/gi)
      .map(s => s.trim())
      .filter(s => s.length > 0);
  }

  function extractPlaceCandidatesFromText(text) {
    if (!text) return [];
    // Remove common markdown symbols that interfere with word detection
    text = text.replace(/[\*#`_>]/g, ' ');
    // Heuristic: capture capitalized word sequences (optionally with connectors like de, of, the)
    const connectors = '(?:de|la|del|di|da|do|du|of|the|and|&|y)';
    const pattern = new RegExp(
      `\\b([A-Z][a-z√Ä-√ñ√ò-√∂√∏-√ø]+(?:\\s+(?:${connectors}|[A-Z][a-z√Ä-√ñ√ò-√∂√∏-√ø]+|[A-Z]{2,}))*)\\b`,
      'g'
    );
    const blacklist = new Set([
      'Morning', 'Afternoon', 'Evening', 'Night', 'Lunch', 'Dinner', 'Breakfast',
      'Day', 'Additional Tips', 'AM', 'PM', 'Options', 'Activity', 'Transport', 'Time'
    ]);
    const results = new Set();
    let m;
    while ((m = pattern.exec(text)) !== null) {
      const candidate = m[1].trim();
      if (candidate.length < 3) continue;
      if (blacklist.has(candidate)) continue;
      // Skip lines that are clearly not places (contain numbers-only or overly long)
      if (/^\d/.test(candidate)) continue;
      if (candidate.length > 60) continue;
      results.add(candidate);
      if (results.size >= 12) break;
    }
    return Array.from(results);
  }

  async function geocodeName(name) {
    const variants = [
      name,
      `${name} country`,
      `${name} city`,
      `${name}, Europe`
    ];
    for (const query of variants) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&q=${encodeURIComponent(query)}`;
        const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const json = await r.json();
        if (Array.isArray(json) && json.length > 0) {
          const { lat, lon, display_name, address = {}, class: cls, type } = json[0];
          const countryCode = (address.country_code || '').toUpperCase();
          return { name: name, label: display_name || name, lat: parseFloat(lat), lng: parseFloat(lon), countryCode, cls, type };
        }
      } catch (e) { /* ignore and try next variant */ }
      // Be polite to the service
      await new Promise(res => setTimeout(res, 200));
    }
    return null;
  }

  // Fallback geocoder using Photon (Komoot)
  async function geocodeFallback(name) {
    try {
      const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(name)}&limit=1`;
      const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const json = await r.json();
      if (json && Array.isArray(json.features) && json.features.length > 0) {
        const f = json.features[0];
        const [lng, lat] = f.geometry && Array.isArray(f.geometry.coordinates) ? f.geometry.coordinates : [null, null];
        if (lat != null && lng != null) {
          const props = f.properties || {};
          const label = props.name || props.city || props.country || name;
          const countryCode = (props.countrycode || '').toUpperCase();
          const cls = props.type === 'city' ? 'place' : 'tourism';
          const type = props.type || 'city';
          return { name, label, lat: parseFloat(lat), lng: parseFloat(lng), countryCode, cls, type };
        }
      }
    } catch (e) { /* ignore */ }
    return null;
  }

  async function geocodeNameWithFallback(name) {
    return (await geocodeName(name)) || (await geocodeFallback(name));
  }

  async function updateMapPins(destinationInput, itineraryText) {
    try {
      initHomeMap();
      const inputNames = parseDestinationInput(destinationInput);
      const dedup = (arr) => { const s = new Set(); return arr.filter(n=>{const k=n.toLowerCase(); if(s.has(k)) return false; s.add(k); return true;}); };
      const results = [];
      // Only plot user-entered destinations for now to avoid random pins from itinerary parsing
      const namesToPlot = dedup(inputNames && inputNames.length ? inputNames : [(destinationInput||'').trim()]);
      for (const name of namesToPlot) {
        if (!name) continue;
        const geo = await geocodeNameWithFallback(name);
        if (geo) results.push(geo);
        await new Promise(res => setTimeout(res, 200));
      }

      if (!results.length) {
        console.log('Map: no geocoded results for user-entered destinations', namesToPlot);
        return;
      }

      homeMarkerLayer.clearLayers();
      const bounds = [];
      results.forEach(p => {
        const m = L.marker([p.lat, p.lng]).addTo(homeMarkerLayer);
        m.bindPopup(p.label || p.name);
        bounds.push([p.lat, p.lng]);
      });
      if (bounds.length === 1) {
        homeMapInstance.setView(bounds[0], 8);
      } else {
        homeMapInstance.fitBounds(bounds, { padding: [30, 30] });
      }
      homeSaveMarkers(homeGetCurrentMarkers());
    } catch (e) {
      console.log('Plotting failed:', e);
    }
  }

  // Save current itinerary to local storage
  function saveItinerary() {
    if (!window.currentItinerary) {
      alert("No itinerary to save! Generate a trip plan first.");
      return;
    }
    
    const savedItineraries = JSON.parse(localStorage.getItem('travelItineraries') || '[]');
    const itineraryName = prompt("Give your itinerary a name:", 
      `${window.currentItinerary.destination} Trip - ${new Date(window.currentItinerary.dateFrom).toLocaleDateString()}`);
    
    if (itineraryName) {
      const itineraryToSave = {
        ...window.currentItinerary,
        name: itineraryName,
        id: Date.now()
      };
      
      savedItineraries.push(itineraryToSave);
      localStorage.setItem('travelItineraries', JSON.stringify(savedItineraries));
      
      alert("‚úÖ Itinerary saved successfully!");
      loadSavedItineraries();
    }
  }
  
  // Load and display saved itineraries
  function loadSavedItineraries() {
    const savedItineraries = JSON.parse(localStorage.getItem('travelItineraries') || '[]');
    const savedList = document.getElementById('saved-list');
    const section = document.getElementById('saved-itineraries-section');
    
    if (savedItineraries.length === 0) {
      section.style.display = 'none';
      savedList.innerHTML = '';
      return;
    }
    section.style.display = 'block';
    const toShow = savedItineraries.slice(-2); // show the most recent two

    savedList.innerHTML = toShow.map(itinerary => `
      <div class="saved-itinerary" data-id="${itinerary.id}">
        <div class="itinerary-header">
          <h4>${itinerary.name}</h4>
          <div class="itinerary-actions-mini">
            <button onclick="viewItinerary(${itinerary.id})" class="view-btn">üëÅÔ∏è View</button>
            <button onclick="deleteItinerary(${itinerary.id})" class="delete-btn">üóëÔ∏è Delete</button>
          </div>
        </div>
        <div class="itinerary-details">
          <p><strong>Destination:</strong> ${itinerary.destination}</p>
          <p><strong>Dates:</strong> ${new Date(itinerary.dateFrom).toLocaleDateString()} - ${new Date(itinerary.dateTo).toLocaleDateString()}</p>
          <p><strong>Preferences:</strong> ${itinerary.preferences}</p>
          <p><strong>Saved:</strong> ${new Date(itinerary.timestamp).toLocaleDateString()}</p>
        </div>
      </div>
    `).join('');

    // If more than two exist, add a "View more" button to dashboard history
    if (savedItineraries.length > 2) {
      const more = document.createElement('div');
      more.style.marginTop = '10px';
      more.innerHTML = `<a href="/dashboard.html#travel-history" class="btn" style="text-decoration:none;">‚úàÔ∏èüìú View more</a>`;
      savedList.appendChild(more);
    }
  }
  
  // View a specific itinerary
  function viewItinerary(id) {
    const savedItineraries = JSON.parse(localStorage.getItem('travelItineraries') || '[]');
    const itinerary = savedItineraries.find(i => i.id === id);
    
    if (itinerary) {
      const viewWindow = window.open('', '_blank');
      viewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${itinerary.name}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
            .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
            h1 { color: #00796b; border-bottom: 2px solid #00796b; padding-bottom: 10px; }
            .detail { margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 5px; }
            .itinerary-response { background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0; white-space: pre-wrap; }
            .print-btn { background: #00796b; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
            .print-btn:hover { background: #005a4f; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>${itinerary.name}</h1>
            <div class="detail"><strong>Destination:</strong> ${itinerary.destination}</div>
            <div class="detail"><strong>Travel Dates:</strong> ${new Date(itinerary.dateFrom).toLocaleDateString()} - ${new Date(itinerary.dateTo).toLocaleDateString()}</div>
            <div class="detail"><strong>Preferences:</strong> ${itinerary.preferences}</div>
            <div class="detail"><strong>Saved on:</strong> ${new Date(itinerary.timestamp).toLocaleDateString()}</div>
            <h3>AI Travel Plan:</h3>
            <div class="itinerary-response">${formatItineraryBodyHTML(itinerary.response)}</div>
            <button onclick="window.print()" class="print-btn">üñ®Ô∏è Print Itinerary</button>
            <button onclick="window.close()" class="print-btn">‚ùå Close</button>
          </div>
        </body>
        </html>
      `);
    }
  }
  
  // Delete a saved itinerary
  function deleteItinerary(id) {
    if (confirm("Are you sure you want to delete this itinerary?")) {
      const savedItineraries = JSON.parse(localStorage.getItem('travelItineraries') || '[]');
      const updatedItineraries = savedItineraries.filter(i => i.id !== id);
      localStorage.setItem('travelItineraries', JSON.stringify(updatedItineraries));
      
      alert("üóëÔ∏è Itinerary deleted successfully!");
      loadSavedItineraries();
    }
  }
  
  // Share itinerary (copy to clipboard)
  function shareItinerary() {
    if (!window.currentItinerary) {
      alert("No itinerary to share! Generate a trip plan first.");
      return;
    }
    
    const cleanPlan = formatItineraryToPlainText(window.currentItinerary.response);
    const shareText = `üåç Travel Itinerary: ${window.currentItinerary.destination}
üìÖ Dates: ${new Date(window.currentItinerary.dateFrom).toLocaleDateString()} - ${new Date(window.currentItinerary.dateTo).toLocaleDateString()}
üéØ Preferences: ${window.currentItinerary.preferences}
ü§ñ AI Plan:
${cleanPlan}
Generated by AI Travel Buddy ‚úàÔ∏è`;
    
    navigator.clipboard.writeText(shareText).then(() => {
      alert("üìã Itinerary copied to clipboard! You can now paste it anywhere.");
    }).catch(() => {
      // Fallback for older browsers
      const textArea = document.createElement("textarea");
      textArea.value = shareText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert("üìã Itinerary copied to clipboard! You can now paste it anywhere.");
    });
  }

  // Edit itinerary flow
  function editItinerary() {
    const editor = document.getElementById('itinerary-editor');
    const textarea = document.getElementById('itinerary-edit-text');
    const current = (window.currentItinerary && window.currentItinerary.response) ? String(window.currentItinerary.response) : '';
    textarea.value = current;
    editor.style.display = 'block';
    textarea.focus();
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
  }

  function cancelEditItinerary() {
    const editor = document.getElementById('itinerary-editor');
    editor.style.display = 'none';
  }

  function saveEditedItinerary() {
    const textarea = document.getElementById('itinerary-edit-text');
    const newText = textarea.value || '';
    // Update currentItinerary
    if (!window.currentItinerary) window.currentItinerary = {};
    window.currentItinerary.response = newText;
    // Re-render
    const modalBody = document.getElementById('itinerary-modal-body');
    modalBody.innerHTML = formatItinerary(newText);
    // Re-plot markers using edited text
    const destination = document.getElementById('destination').value;
    plotFromInputAndItinerary(destination, newText);
    // Hide editor
    cancelEditItinerary();
  }

  // Close itinerary modal
  (function initModalClose(){
    const modal = document.getElementById('itinerary-modal');
    const closeBtn = document.getElementById('itinerary-modal-close');
    if (closeBtn) {
      closeBtn.addEventListener('click', function(){ 
        modal.style.display = 'none';
        // Ensure inline action buttons are hidden when closing modal
        const actions = document.getElementById('itinerary-actions');
        if (actions) actions.style.display = 'none';
      });
    }
    // Click outside to close
    modal.addEventListener('click', function(e){
      if (e.target === modal) {
        modal.style.display = 'none';
        const actions = document.getElementById('itinerary-actions');
        if (actions) actions.style.display = 'none';
      }
    });
  })();
  
  // Load saved itineraries when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadSavedItineraries();
    initHomeMap();
  });

  // Home Map logic
  const HOME_MAP_MARKERS_KEY = 'atb_home_map_markers';
  let homeMapInstance;
  let homeMarkerLayer;

  function homeLoadSavedMarkers() {
    try { return JSON.parse(localStorage.getItem(HOME_MAP_MARKERS_KEY) || '[]'); } catch(e) { return []; }
  }
  function homeSaveMarkers(markers) {
    localStorage.setItem(HOME_MAP_MARKERS_KEY, JSON.stringify(markers));
  }
  function homeGetCurrentMarkers() {
    const markers = [];
    if (!homeMarkerLayer) return markers;
    homeMarkerLayer.eachLayer(layer => {
      if (layer.getLatLng) {
        const { lat, lng } = layer.getLatLng();
        markers.push({ lat, lng });
      }
    });
    return markers;
  }
  function initHomeMap() {
    if (homeMapInstance) return;
    homeMapInstance = L.map('home-map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(homeMapInstance);
    homeMarkerLayer = L.layerGroup().addTo(homeMapInstance);
    const saved = homeLoadSavedMarkers();
    saved.forEach(({ lat, lng }) => L.marker([lat, lng]).addTo(homeMarkerLayer));
    homeMapInstance.on('click', (e) => {
      L.marker([e.latlng.lat, e.latlng.lng]).addTo(homeMarkerLayer);
      homeSaveMarkers(homeGetCurrentMarkers());
    });
  }
  function homeLocateUser() {
    if (!homeMapInstance) return;
    if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition((pos) => {
      const { latitude, longitude } = pos.coords;
      homeMapInstance.setView([latitude, longitude], 12);
      L.marker([latitude, longitude]).addTo(homeMarkerLayer);
      homeSaveMarkers(homeGetCurrentMarkers());
    }, () => alert('Unable to retrieve location'));
  }
  function homeClearMapMarkers() {
    if (!homeMarkerLayer) return;
    homeMarkerLayer.clearLayers();
    homeSaveMarkers([]);
  }

</script>

</body>
</html>
